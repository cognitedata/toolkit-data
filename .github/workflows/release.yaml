name: Zip, Checksum, and Update README on Main Merge

on:
  push:
    branches:
      - librarian
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      zip_name: ${{ steps.file_names.outputs.zip_name }}
      checksum: ${{ steps.checksum.outputs.sha256_hash }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Generate a dynamic zip file name
        id: file_names
        run: |
          ZIP_NAME=$(echo "modules" | tr '/' '-')
          echo "zip_name=${ZIP_NAME}.zip" >> $GITHUB_OUTPUT

      - name: Create Zip File
        run: zip -r ${{ steps.file_names.outputs.zip_name }} modules/

      - name: Generate SHA256 Checksum
        id: checksum
        run: |
          checksum_value=$(sha256sum ${{ steps.file_names.outputs.zip_name }} | awk '{ print $1 }')
          echo "sha256_hash=${checksum_value}" >> $GITHUB_OUTPUT

      - name: Upload Zip as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.file_names.outputs.zip_name }}
          path: ${{ steps.file_names.outputs.zip_name }}

      - name: Save checksum and filename for README job
        # This creates a file containing the metadata for the update-readme job
        run: |
          echo "${{ steps.file_names.outputs.zip_name }},sha256:${{ steps.checksum.outputs.sha256_hash }}" >> checksum_data.txt

      - name: Upload metadata for README job
        # This artifact is temporary and will be used by the next job
        uses: actions/upload-artifact@v4
        with:
          name: metadata-modules
          path: checksum_data.txt

  create-release:
    # This job runs only after the build job has succeeded
    needs: build
    runs-on: ubuntu-latest

    # Grant permissions for the action to create releases
    permissions:
      contents: write

    steps:
      - name: Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.zip_name }}

      - name: Download metadata artifact
        uses: actions/download-artifact@v4
        with:
          name: metadata-modules

      - name: Check out repository for packages.toml
        uses: actions/checkout@v4

      - name: Generate packages list
        id: packages_list
        run: |
          # Read packages.toml and extract package information
          PACKAGES_CONTENT=""
          
          # Use awk to parse the packages.toml file and extract package names and descriptions
          while IFS= read -r line; do
            if [[ $line =~ ^\[packages\.([^\]]+)\] ]]; then
              PACKAGE_NAME="${BASH_REMATCH[1]}"
              # Read the next few lines to get title and description
              TITLE=""
              DESCRIPTION=""
              while IFS= read -r next_line; do
                if [[ $next_line =~ ^\[ ]]; then
                  break
                fi
                if [[ $next_line =~ ^title\s*=\s*\"([^\"]+)\" ]]; then
                  TITLE="${BASH_REMATCH[1]}"
                fi
                if [[ $next_line =~ ^description\s*=\s*\"([^\"]+)\" ]]; then
                  DESCRIPTION="${BASH_REMATCH[1]}"
                fi
              done < <(tail -n +$(( $(grep -n "^\[packages\.$PACKAGE_NAME\]" modules/packages.toml | cut -d: -f1) + 1 )) modules/packages.toml | head -10)
              
              PACKAGES_CONTENT+="- **$PACKAGE_NAME**: $TITLE - $DESCRIPTION"$'\n'
            fi
          done < modules/packages.toml
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PACKAGES_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release tag
        id: tag
        run: |
          # Get the latest release tag to determine the next patch version
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # Extract the version numbers
          if [[ $LATEST_TAG =~ v([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            MAJOR=${BASH_REMATCH[1]}
            MINOR=${BASH_REMATCH[2]}
            PATCH=${BASH_REMATCH[3]}
          else
            # Default to 1.0.0 if no valid tag found
            MAJOR=1
            MINOR=0
            PATCH=0
          fi
          
          # Increment patch version
          NEW_PATCH=$((PATCH + 1))
          NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Generated tag: $NEW_TAG"

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: "Modules Release ${{ steps.tag.outputs.tag }}"
          body: |
            ## Usage:
            
            ```cdf.toml

            [libraries.toolkit-data]
            url = "https://github.com/cdf-dev/toolkit-data/releases/download/{{ steps.tag.outputs.tag }}/${{ needs.build.outputs.zip_name }}"
            sha256 = "sha256:${{ needs.build.outputs.checksum }}"
            ```

            ## Content:
            
            This release contains the following packages:
            
            ${{ steps.packages_list.outputs.content }}


          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ needs.build.outputs.zip_name }}
          asset_name: ${{ needs.build.outputs.zip_name }}
          asset_content_type: application/zip